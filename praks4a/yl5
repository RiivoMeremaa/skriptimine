#!/bin/bash

read -r -p "Sisesta kataloogi tee, mida soovid varundada: " kataloog
kataloog="${kataloog/#\~/$HOME}"

if [[ ! -d "$kataloog" ]]; then
    echo "Kataloogi '$kataloog' ei eksisteeri."
    exit 1
fi

if [[ ! -r "$kataloog" ]]; then
    echo "Selle kausta varundamiseks on vaja lugemisõigusi."
    exit 1
fi

read -r -p "Sisesta kataloog, kuhu soovid backupi salvestada: " backup_kataloog
backup_kataloog="${backup_kataloog/#\~/$HOME}"

if [[ ! -d "$backup_kataloog" ]]; then
    echo "Backup kataloogi '$backup_kataloog' ei eksisteeri."
    exit 1
fi

if [[ ! -w "$backup_kataloog" ]]; then
    echo "Backup kataloogi '$backup_kataloog' kirjutamise õigused puuduvad."
    exit 1
fi

katalooginimi=$(basename "$kataloog")
kuupaev=$(date +"%d%b%Y" | tr '[:upper:]' '[:lower:]')

leia_vaba_failinimi() {
    local baasnimi="$1"
    local sihtkataloog="$2"
    local kuup="$3"
    local number=1
    local failinimi="${baasnimi}.backup.${kuup}.tar.gz"

    if [[ ! -e "$sihtkataloog/$failinimi" ]]; then
        echo "$failinimi"
        return
    fi

    while [[ -e "$sihtkataloog/${baasnimi}.backup.${kuup}.${number}.tar.gz" ]]; do
        ((number++))
    done

    echo "${baasnimi}.backup.${kuup}.${number}.tar.gz"
}

failinimi=$(leia_vaba_failinimi "$katalooginimi" "$backup_kataloog" "$kuupaev")

if [[ -e "$backup_kataloog/$katalooginimi.backup.tar.gz" ]]; then
    read -r -p "Backup fail '$katalooginimi.backup.tar.gz' juba olemas. Kas soovid luua uue varukoopia versiooni? (jah/ei): " vastus
    if [[ ! "$vastus" =~ ^(jah|Jah|JAH)$ ]]; then
        echo "Varundamine katkestatud."
        exit 0
    fi
    failinimi=$(leia_vaba_failinimi "$katalooginimi" "$backup_kataloog" "$kuupaev")
fi

if tar -czf "$backup_kataloog/$failinimi" -C "$(dirname "$kataloog")" "$katalooginimi"; then
    echo "Varundamine lõpetatud. Fail salvestatud: $backup_kataloog/$failinimi"
else
    echo "Varundamine ebaõnnestus. Kontrolli õigusi ja tee uuesti proovimist."
    [[ -f "$backup_kataloog/$failinimi" ]] && rm -f "$backup_kataloog/$failinimi"
    exit 1
fi
